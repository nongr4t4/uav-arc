<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>UAV Конфігуратор</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
            max-width: 1000px;
            background: #f4f4f4;
        }
        h1, h2, h3 {
            margin-bottom: 8px;
        }
        input, select {
            width: 250px;
            margin-bottom: 10px;
            padding: 6px;
            font-size: 14px;
        }
        button {
            padding: 10px 16px;
            background: #2d72d9;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
        }
        button:disabled {
            opacity: 0.6;
            cursor: default;
        }
        #result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .section {
            margin-top: 18px;
            padding-top: 12px;
            border-top: 1px solid #ddd;
        }
        .label {
            font-weight: bold;
        }
        .pill-ok {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            background: #d9f7c7;
            color: #256029;
            font-size: 12px;
            margin-left: 8px;
        }
        .pill-bad {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            background: #ffd2d2;
            color: #a00000;
            font-size: 12px;
            margin-left: 8px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 8px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            font-size: 14px;
        }
        th {
            background: #f0f0f0;
        }
        .mono {
            font-family: Consolas, monospace;
        }
        .small {
            font-size: 13px;
            color: #555;
        }
    </style>
</head>

<body>

<h1>UAV Конфігуратор</h1>
<p class="small">Введи вимоги до місії — отримаєш розраховану гвинтомоторну групу, її аналіз та рекомендовані компоненти.</p>

<div id="form">
    <label>Час польоту (години):</label><br>
    <input id="timeHours" type="number" value="2" step="0.1"><br>

    <label>Радіус дії (км):</label><br>
    <input id="radiusKm" type="number" value="30" step="1"><br>

    <label>Корисне навантаження (кг):</label><br>
    <input id="payloadKg" type="number" value="10" step="0.1"><br>

    <label>Низький шум:</label><br>
    <select id="lowNoise">
        <option value="true">Так</option>
        <option value="false">Ні</option>
    </select><br>

    <label>Бюджет ($):</label><br>
    <input id="budget" type="number" value="50000" step="100"><br><br>

    <button id="calcBtn" onclick="sendRequest()">Розрахувати</button>
</div>

<div id="result">
    <h2>Результат з'явиться тут</h2>
</div>

<script>
function humanPropulsion(code) {
    if (code === "electric") return "Електрична ГМГ (електродвигун + акумулятор)";
    if (code === "piston_engine") return "Поршневий бензиновий/дизельний ДВЗ";
    if (code === "turbine") return "Турбінна/реактивна силова установка";
    return code;
}

function humanMission(code) {
    if (code === "tactical") return "Тактична глибина";
    if (code === "operational") return "Оперативна глибина";
    if (code === "strategic") return "Стратегічна глибина";
    return code;
}

async function sendRequest() {
    const data = {
        timeHours: parseFloat(document.getElementById("timeHours").value),
        radiusKm: parseFloat(document.getElementById("radiusKm").value),
        payloadKg: parseFloat(document.getElementById("payloadKg").value),
        lowNoise: document.getElementById("lowNoise").value === "true",
        budget: parseFloat(document.getElementById("budget").value)
    };

    const resultBox = document.getElementById("result");
    const btn = document.getElementById("calcBtn");

    resultBox.innerHTML = "<h2>⏳ Виконується розрахунок...</h2>";
    btn.disabled = true;

    try {
        const response = await fetch("https://uav-arc-backend.onrender.com/api/configure", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const text = await response.text();
            resultBox.innerHTML = `
                <h2>❌ Помилка сервера (${response.status})</h2>
                <pre class="small">${text}</pre>
            `;
            btn.disabled = false;
            return;
        }

        const json = await response.json();
        renderResult(json, data);

    } catch (err) {
        resultBox.innerHTML = `
            <h2>❌ Помилка запиту</h2>
            <p class="small">${err}</p>
        `;
    } finally {
        btn.disabled = false;
    }
}

function renderResult(json, input) {
    const resultBox = document.getElementById("result");

    const mission = json.mission;
    const calc = json.calculations;
    const comps = json.gmgroup?.recommendedProp || {};
    const aiText = json.ai?.summary || "";
    const engine = comps.engine || {};
    const prop = comps.propeller || {};
    const elec = comps.electronics || {};

    const meetsRadius = mission.meetsRadius;
    const meetsRadiusPill = meetsRadius
        ? `<span class="pill-ok">радіус досяжний</span>`
        : `<span class="pill-bad">радіус не досягається</span>`;

    // Блок 1 — Вихідні дані
    const blockInput = `
        <div class="section">
            <h2>1. Вхідні вимоги місії</h2>
            <p><span class="label">Час польоту:</span> ${input.timeHours} год</p>
            <p><span class="label">Необхідний радіус дії:</span> ${input.radiusKm} км</p>
            <p><span class="label">Корисне навантаження:</span> ${input.payloadKg} кг</p>
            <p><span class="label">Вимога до шуму:</span> ${input.lowNoise ? "Низький" : "Може бути підвищений"}</p>
            <p><span class="label">Бюджет:</span> $${input.budget}</p>
        </div>
    `;

    // Блок 2 — Характеристики ГМГ
    const blockGmg = `
        <div class="section">
            <h2>2. Розраховані характеристики ГМГ</h2>
            <p><span class="label">Клас місії:</span> ${humanMission(mission.missionType)}</p>
            <p>
                <span class="label">Тип силової установки:</span> ${humanPropulsion(mission.propulsion)}
            </p>
            <p>
                <span class="label">Реальний досяжний радіус:</span>
                ${mission.achievableRadius} км
                (${mission.requiredRadius} км потрібно) ${meetsRadiusPill}
            </p>
            <p><span class="label">Розрахункова дальність:</span> ${calc.range_km} км</p>
            <p><span class="label">Розрахункова тяга / опір (T=D):</span> ${calc.drag_N} Н</p>
            <p><span class="label">Необхідна потужність у крейсері:</span> ${calc.power_W} Вт</p>
            <p><span class="label">Маса палива / батареї:</span> ${calc.fuelOrBattery_kg} кг</p>
            <p><span class="label">Злітна маса (MTOW):</span> ${calc.mtow_kg} кг</p>
        </div>
    `;

    // Блок 3 — Обґрунтування вибору ГМГ (як твої приклади)
    const blockJustification = `
        <div class="section">
            <h2>3. Обґрунтування вибору ГМГ</h2>
            <p>
                <b>Тип двигуна:</b>
                ${engine.model ? engine.model + " — " : ""}${humanPropulsion(mission.propulsion)} обрано на основі вимог до
                тривалості польоту, радіуса дії та бюджету. Така силова установка забезпечує розрахунковий час польоту
                ${input.timeHours} год і радіус ${mission.achievableRadius} км, що перевищує необхідні ${mission.requiredRadius} км
                для заданої місії.
            </p>
            <p>
                <b>Пропелер:</b>
                ${prop.model ? prop.model + " — " : "Рекомендований пропелер — "} 
                ${prop.reason || "забезпечує прийнятний баланс між тягою та ефективністю в крейсерському режимі."}
            </p>
            <p>
                <b>Альтернативи:</b>
                при збільшенні бюджету можливе використання більш потужної силової установки або переходу на інший клас
                двигунів (наприклад, ${mission.missionType === "operational" ? "легку турбіну для збільшення швидкості" : "дизельний ДВЗ з меншою питомою витратою палива"}), 
                але для даних вимог це не є обов'язковим.
            </p>
        </div>
    `;

    // Блок 4 — Таблиця рекомендованих компонентів
    const blockComponents = `
        <div class="section">
            <h2>4. Рекомендовані компоненти ГМГ (у межах бюджету)</h2>
            <table>
                <thead>
                    <tr>
                        <th>Підсистема</th>
                        <th>Модель</th>
                        <th>Орієнтовна ціна, $</th>
                        <th>Пояснення вибору</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Двигун</td>
                        <td>${engine.model || "—"}</td>
                        <td>${engine.price !== undefined ? engine.price : "—"}</td>
                        <td>${engine.reason || "—"}</td>
                    </tr>
                    <tr>
                        <td>Пропелер</td>
                        <td>${prop.model || "—"}</td>
                        <td>${prop.price !== undefined ? prop.price : "—"}</td>
                        <td>${prop.reason || "—"}</td>
                    </tr>
                    <tr>
                        <td>Бортова електроніка</td>
                        <td>${elec.model || "—"}</td>
                        <td>${elec.price !== undefined ? elec.price : "—"}</td>
                        <td>${elec.reason || "—"}</td>
                    </tr>
                </tbody>
            </table>
            <p class="small">
                * Реальні ціни залежать від постачальника та партії закупівлі. Таблиця показує орієнтовний рівень витрат на ГМГ у
                структурі загального бюджету $${input.budget}.
            </p>
        </div>
    `;

    // Блок 5 — Інженерний висновок AI
    const blockAI = `
        <div class="section">
            <h2>5. Інженерний висновок (Gemini)</h2>
            <div style="background:#fafafa; padding:10px 12px; border-radius:8px; border:1px solid #eee;">
                ${aiText}
            </div>
        </div>
    `;

    resultBox.innerHTML = `
        ${blockInput}
        ${blockGmg}
        ${blockJustification}
        ${blockComponents}
        ${blockAI}
    `;
}
</script>

</body>
</html>
